# YFEvents Architecture Documentation
# Last Updated: Authentication System Unified, YFClaim Refactored

project:
  name: YFEvents
  version: 2.3.0
  description: Community Events Platform with Clean Architecture
  namespace: YFEvents
  status: development-environment-ready
  completion: 96%  # Chat implemented, homepage overhauled, item gallery added

architecture:
  pattern: Clean Architecture (Hexagonal)
  principles:
    - Domain-Driven Design (DDD)
    - SOLID Principles
    - Dependency Inversion
    - Repository Pattern
    - Service Layer Pattern

structure:
  root:
    - config/          # Configuration files (database, app, email, services)
    - database/        # SQL schemas and migrations
    - docs/           # Project documentation
    - modules/        # Independent feature modules
    - public/         # Web root (minimal exposure)
    - resources/      # Views, assets, templates
    - routes/         # Route definitions
    - scripts/        # Utility and maintenance scripts
    - src/           # Core application code
    - storage/       # Runtime storage (logs, cache, sessions)
    - tests/         # Test suites
    - vendor/        # Composer dependencies

  src:
    layers:
      domain:
        path: src/Domain/
        description: Business logic and entities
        components:
          - Events/       # Event management
          - Shops/        # Shop/business listings
          - Users/        # User management
          - Claims/       # Estate sale claims
          - Communication/ # Real-time chat and messaging system
          - Scrapers/     # Web scraping interfaces
          - Common/       # Shared interfaces
        
      application:
        path: src/Application/
        description: Use cases and application services
        components:
          - Services/     # Application services (includes unified AuthService)
          - Controllers/  # Admin controllers
          - Validation/   # Input validation
          - Bootstrap.php # Application initialization
          
      infrastructure:
        path: src/Infrastructure/
        description: External implementations
        components:
          - Config/       # Configuration management
          - Container/    # Dependency injection
          - Database/     # Database connections
          - Repositories/ # Repository implementations
          - Services/     # Infrastructure services
          - Http/         # HTTP handling (Router, ErrorHandler)
          - Utils/        # Utilities (EnvLoader, etc.)
          
      presentation:
        path: src/Presentation/
        description: User interface layer
        components:
          - Api/          # API controllers
          - Http/         # Web controllers

modules:
  structure:
    yfauth:
      namespace: YFEvents\Modules\YFAuth
      description: Authentication and authorization (centralized auth provider)
      status: active
      components:
        - src/Models/
        - src/Services/
        - src/Middleware/
        - database/schema.sql
        - www/          # Module web files
      notes:
        - Now used by all modules via unified AuthService
        - Handles all user authentication (admin, sellers, buyers)
        
    yfclaim:
      namespace: YFEvents\Modules\YFClaim
      description: Estate sale system (offers/bidding removed)
      status: active
      components:
        - src/Models/
        - src/Services/
        - src/Utils/
        - database/schema.sql
        - www/          # Module web files
      changes:
        - Removed: Offer/bidding functionality
        - Added: Contact form system for inquiries
        - Modified: Sellers authenticate via YFAuth
        - Database: password_hash column now nullable
        
    yftheme:
      namespace: YFEvents\Modules\YFTheme
      description: Theme customization system
      status: active
      components:
        - src/Models/
        - src/Services/
        - database/schema.sql
        - www/          # Module web files

    yfchat:
      namespace: YFEvents\Domain\Communication
      description: Real-time chat and messaging system
      status: completed
      components:
        - src/Domain/Communication/       # Entities, ValueObjects, Interfaces
        - src/Application/Services/Communication/  # Services
        - src/Infrastructure/Repositories/Communication/ # Repositories
        - src/Presentation/Api/Controllers/Communication/ # API Controllers
        - database/communication_schema_fixed.sql
        - www/html/communication/         # Web interface files
      features:
        - Global admin-seller chat rooms (Support, Selling Tips)
        - Direct messaging capability
        - File attachments
        - Message reactions and threading
        - Email integration
        - Real-time notifications
        - PWA support with offline capability
      architecture:
        - Clean Architecture implementation
        - Domain-driven design
        - Repository pattern
        - Service layer orchestration
        
    yfclassifieds:
      namespace: YFEvents\Modules\YFClassifieds
      description: Classified listings
      status: inactive  # Overlaps with YFClaim
      note: Functionality merged into YFClaim

configuration:
  environment:
    file: .env
    example: .env.example
    loader: YFEvents\Infrastructure\Utils\EnvLoader
    
  files:
    - config/database.php    # Database settings (uses env vars)
    - config/app.php        # Application settings (uses env vars)
    - config/email.php      # Email configuration (uses env vars)
    - config/services/      # Service configurations
    
  entry_point:
    file: public/index.php
    bootstrap: YFEvents\Application\Bootstrap
    router: YFEvents\Infrastructure\Http\Router

authentication:
  unified_system:
    service: YFEvents\Application\Services\AuthService
    provider: YFEvents\Modules\YFAuth\Services\AuthService
    description: Centralized authentication wrapper
    features:
      - Single login interface for all user types
      - Standardized session management
      - Role-based access control (RBAC)
      - Automatic session regeneration
    session_structure:
      auth:
        - user_id
        - username
        - email
        - roles[]
        - permissions[]
        - session_id
        - login_time
        - last_activity
  
  deprecated:
    - Legacy admin authentication (hardcoded credentials)
    - Direct YFClaim seller authentication
    - Multiple session variable patterns
    - Hardcoded passwords in controllers

database:
  connection: MySQL/MariaDB
  name: yakima_finds
  user_table: yfa_auth_users    # Standardized from 'users' references
  tables:
    core:
      - events
      - event_categories
      - calendar_sources    # Moved before events to resolve FK dependency
      - local_shops
      - shop_categories    # Moved before local_shops to resolve FK dependency
      - shop_owners       # Moved before local_shops to resolve FK dependency
      
    modules:
      - yfa_auth_*        # YFAuth module tables (includes main user table)
      - yfc_*             # YFClaim module tables (yfc_sellers.password_hash now nullable)
      - theme_*           # YFTheme module tables
      
    communication:
      - communication_channels      # Chat channels/rooms
      - communication_messages      # Messages with threading support
      - communication_participants  # Channel membership and permissions
      - communication_attachments   # File attachments for messages
      - communication_reactions     # Message reactions (emoji)
      - communication_notifications # User notifications and alerts
      - communication_email_addresses # Email integration for channels
      
    system:
      - modules
      - module_settings
      - audit_log
      - scraping_logs

testing:
  structure:
    - tests/Unit/          # Unit tests
    - tests/Feature/       # Feature tests
    - tests/Integration/   # Integration tests
    - tests/Scripts/       # Migrated script tests

deployment:
  composer:
    autoload:
      "YFEvents\\": "src/"
      "YFEvents\\Modules\\": "modules/"
    autoload-dev:
      "YFEvents\\Tests\\": "tests/"
      
  commands:
    - composer install
    - composer dump-autoload -o
    - cp .env.example .env
    - # Configure .env with actual values
    - # Run database import: ./scripts/import_database.sh
  
  automated_deployment:
    location: scripts/deploy/
    target_platform: Digital Ocean (Ubuntu 22.04)
    process:
      - wget deployment scripts from GitHub
      - Run setup-server.sh to prepare LAMP stack
      - Run deploy.sh with repository URL
      - Script clones to /var/www/yfevents
      - Configures Apache, SSL, database, and cron
    scripts:
      setup-server.sh: Installs LAMP stack and dependencies
      deploy.sh: Main deployment orchestrator
      create-admin.php: Interactive admin user creation
      health-check.php: Verifies installation health
      run-sql-files.php: Executes database schemas in order
      apache-vhost.conf: Virtual host template

development_environment:
  platform: Ubuntu 22.04 LTS (WSL2)
  stack:
    - PHP 8.1 with required extensions
    - MySQL 8.0
    - Apache 2.4 with mod_rewrite
    - Composer 2.x
  
  configuration:
    - Virtual host configured for localhost
    - Document root: /mnt/d/YFEventsCopy/public
    - Database: yakima_finds (user: yfevents)
    - Environment file: .env with APP_KEY generated
    
  issues_resolved:
    - Router group() method: Simplified routes to not use groups
    - Database foreign key ordering: Reordered table creation
    - User table references: Standardized to yfa_auth_users
    - Composer dependencies: Downgraded from PHP 8.2 to 8.1 compatible

recent_changes:
  authentication_unification:
    - Created unified AuthService wrapper
    - Migrated all authentication to YFAuth module
    - Standardized session variables across system
    - Removed hardcoded admin credentials
    - Updated ClaimsController to use AuthService
    
  yfclaim_refactoring:
    - Removed offer/bidding functionality completely
    - Sellers now authenticate via YFAuth (no local passwords)
    - Fixed database column mappings (preview_start/end vs start_date/end_date)
    - Fixed price field naming (price vs starting_price)
    - Added proper POST routes for form submissions
    - Implemented RESTful seller routes with parameter mapping
    - Contact form system to replace bidding (pending implementation)
    
  database_updates:
    - yfc_sellers.password_hash made nullable
    - Column naming standardized to match actual schema
    - No new migrations needed (working with existing schema)
    
  deprecated_features:
    - YFClaim offer/bidding system
    - Direct password handling in modules
    - Multiple authentication patterns
    - Hardcoded credentials
    - Non-RESTful route patterns

refactoring_progress:
  completed:
    - Phase 1: Preparation and Planning
    - Phase 2: Create Clean Directory Structure
    - Phase 3: Migrate to Clean Architecture
    - Phase 4: Move Assets and Admin
    - Phase 5: Module Integration
    - Phase 6: Database Schema Consolidation (documented, not merged)
    - Phase 7: Clean Up (removed old refactor, organized tests)
    - Phase 8: Configuration Updates
      - Updated composer.json namespaces
      - Created comprehensive .env.example
      - Updated config files to use env vars
      - Fixed entry point paths
    - Phase 9: Namespace Updates
      - Updated all PHP files from YakimaFinds to YFEvents namespace
      - Fixed EnvLoader namespace to YFEvents\Infrastructure\Utils
      - Updated use statements and fully qualified class names
      - 383 references updated to 30 (remaining are string literals)
      
  in_progress:
    - Development Environment Setup:
      - LAMP stack installed and configured
      - Database partially imported (19 tables)
      - Application accessible at http://localhost
      - Chat system fully implemented with communication_* tables
      
  pending:
    - Phase 10: Testing & Verification
    - Phase 11: Final Review
    - Phase 12: Post-Refactor Setup

  chat_system_implementation:
    completed:
      - Domain layer with entities and value objects
      - Infrastructure repositories for all chat tables
      - Application services (CommunicationService, AdminSellerChatService)
      - API controllers for channels, messages, notifications
      - Container registration with dependency injection
      - Database schema using communication_* tables
      - Seed script for global Support and Selling Tips channels
    
    architecture_decisions:
      - Used communication_schema_fixed.sql for advanced features
      - Domain types: public, private, event, vendor, announcement
      - Message types: text, system, announcement
      - Repository pattern with simplified field mapping
      - Service layer for business logic orchestration
      - PWA support with service worker for offline capability
    
    integration:
      - Authentication via YFAuth module
      - Session management standardized
      - Role-based access control
      - YFClaim item references in messages
    
    integration_complete:
      - Seller dashboard integration via iframe
      - Real-time unread badge updates
      - Auto-join channels on seller login
      - API endpoint /api/communication/unread-count
      - Full documentation at docs/CHAT_SYSTEM_DOCUMENTATION.md

  homepage_overhaul:
    completed:
      - Phase 1: Container Registration
        - Fixed QRCodeService interface dependency
        - Created missing Claims repositories (Sale, Item, Offer)
        - Removed offer dependencies from ClaimService
        - Registered all repositories in ServiceProvider
      - Phase 2: Dynamic Homepage Content
        - Created PaginatedResult DTO
        - Injected services into HomeController
        - Added dynamic data fetching methods
        - Fixed Sale::fromArray column mappings
        - Homepage displays dynamic stats and content
      - Phase 3: Item Gallery Feature
        - Added /claims/items route for browsing all items
        - Created ItemRepository methods for cross-sale queries
        - Implemented filtering (category, price, search)
        - Added sorting and pagination
        - Responsive grid layout matching existing design
        - API endpoint for AJAX support
    
    features_added:
      - Dynamic homepage with real data
      - Cross-sale item browsing gallery
      - Advanced filtering and search
      - Responsive design improvements
      - Fallback to static content on errors
    
    database_considerations:
      - Handled column name inconsistencies
      - Category as string (not ID) in items table
      - Image filename vs file_path mapping
      - Compatible with existing production schema

notes:
  - All hardcoded credentials removed from config files and controllers
  - Environment variables used throughout
  - Module system preserved and enhanced
  - Clean Architecture principles applied
  - Backwards compatibility maintained where possible
  - Security improvements implemented (unified auth, session management)
  - Production database schema preserved (with minor nullable adjustments)
  - YFClassifieds module skipped (overlaps with YFClaim)
  - Router simplified to not require group() method
  - Database schemas reordered to resolve dependencies
  - Authentication fully centralized through AuthService
  - YFClaim simplified to focus on sales without bidding complexity
  - RESTful routing patterns implemented for seller workflows
  - Session variables standardized across all modules