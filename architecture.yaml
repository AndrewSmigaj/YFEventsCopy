# YFEvents Architecture Documentation
# Last Updated: Routing System Fully Documented

project:
  name: YFEvents
  version: 2.0.0
  description: Community Events Platform with Clean Architecture
  namespace: YFEvents
  status: production-ready
  completion: 98%  # Routing system fully documented, architecture updated
  php_version: "^8.1"  # Core requirement, some modules require 8.2

architecture:
  pattern: Clean Architecture (Hexagonal)
  principles:
    - Domain-Driven Design (DDD)
    - SOLID Principles
    - Dependency Inversion
    - Repository Pattern
    - Service Layer Pattern

structure:
  root:
    - config/          # Configuration files (database, app, email, services)
    - database/        # SQL schemas and migrations
    - docs/           # Project documentation
    - modules/        # Independent feature modules
    - public/         # Web root (minimal exposure)
    - resources/      # Views, assets, templates
    - routes/         # Route definitions
    - scripts/        # Utility and maintenance scripts
    - src/           # Core application code
    - storage/       # Runtime storage (logs, cache, sessions)
    - tests/         # Test suites
    - vendor/        # Composer dependencies

  src:
    layers:
      domain:
        path: src/Domain/
        description: Business logic and entities
        components:
          - Events/       # Event management
          - Shops/        # Shop/business listings
          - Users/        # User management
          - Claims/       # Estate sale claims
          - Communication/ # Real-time chat and messaging system (NOT a module)
          - Scrapers/     # Web scraping interfaces
          - Common/       # Shared interfaces
        notes:
          - Communication is integrated into core, not a separate module
        
      application:
        path: src/Application/
        description: Use cases and application services
        components:
          - Services/     # Application services (includes unified AuthService)
          - Controllers/  # Admin controllers
          - Validation/   # Input validation
          - Bootstrap.php # Application initialization
          
      infrastructure:
        path: src/Infrastructure/
        description: External implementations
        components:
          - Config/       # Configuration management
          - Container/    # Dependency injection
          - Database/     # Database connections
          - Repositories/ # Repository implementations
          - Services/     # Infrastructure services
          - Http/         # HTTP handling (Router, ErrorHandler)
          - Utils/        # Utilities (EnvLoader, etc.)
        details:
          http:
            router:
              - Handles route registration (get, post, put, delete)
              - Converts {param} patterns to regex capture groups
              - Extracts path parameters to $_GET array
              - No middleware system implemented
              - Direct superglobal usage (no Request/Response objects)
            error_handler:
              - Handles 404 (not found)
              - Handles 405 (method not allowed)
              - Handles 500 (internal server error)
          container:
            - Supports bind(), singleton(), and instance() methods
            - Lazy loading via closures
            - Constructor-based resolution with reflection
            - No auto-wiring capabilities
          
      presentation:
        path: src/Presentation/
        description: User interface layer
        components:
          - Api/          # API controllers
          - Http/         # Web controllers
        details:
          controller_patterns:
            - All controllers receive ContainerInterface and ConfigInterface
            - Manual service resolution in constructors
            - BaseController provides JSON response methods
            - No action injection or parameter binding
          view_rendering:
            - No template engine (Blade/Twig)
            - HomeControllerFixed trait uses output buffering
            - Direct HTML generation in controllers
            - JSON responses for API endpoints
          api_structure:
            - Separate Api\Controllers namespace
            - EventApiController and ShopApiController implemented
            - CORS headers set in constructor
            - RESTful resource methods (index, show, store, etc.)
        notes:
          - HomeControllerFixed trait added for reliable rendering

modules:
  structure:
    yfauth:
      namespace: YFEvents\Modules\YFAuth
      description: Authentication and authorization (centralized auth provider)
      status: active
      components:
        - src/Models/
        - src/Services/
        - src/Middleware/
        - database/schema.sql
        - www/          # Module web files
      notes:
        - Now used by all modules via unified AuthService
        - Handles all user authentication (admin, sellers, buyers)
        
    yfclaim:
      namespace: YFEvents\Modules\YFClaim
      description: Estate sale system with contact-based inquiries
      status: active
      components:
        - src/Models/
        - src/Services/
        - src/Utils/
        - database/schema.sql
        - www/          # Module web files
      changes:
        - Removed: Offer/bidding functionality (migration exists but module.json outdated)
        - Added: Contact form system for inquiries (pending implementation)
        - Modified: Sellers authenticate via YFAuth
        - Database: password_hash column now nullable
      note: module.json still contains outdated auction/bidding references
        
    yftheme:
      namespace: YFEvents\Modules\YFTheme
      description: Theme customization system
      status: active
      components:
        - src/Models/
        - src/Services/
        - database/schema.sql
        - www/          # Module web files

        
    yfclassifieds:
      namespace: YFEvents\Modules\YFClassifieds
      description: Classified listings
      status: inactive  # Overlaps with YFClaim
      note: Functionality merged into YFClaim

configuration:
  environment:
    file: .env
    example: .env.example
    loader: YFEvents\Infrastructure\Utils\EnvLoader
    
  files:
    - config/database.php    # Database settings (uses env vars)
    - config/app.php        # Application settings (uses env vars)
    - config/email.php      # Email configuration (uses env vars)
    - config/services/      # Service configurations
    
  entry_point:
    file: public/index.php
    bootstrap: YFEvents\Application\Bootstrap
    router: YFEvents\Infrastructure\Http\Router
    flow:
      - Bootstrap::boot() creates Container instance
      - ServiceProvider registers all bindings
      - Router instance created with container
      - Route files loaded via closure scope
      - Router::dispatch() handles request

routing_system:
  status: fully_functional
  web_root: /public/
  router: YFEvents\Infrastructure\Http\Router
  routes:
    - routes/web.php        # Web routes (HTML pages)
    - routes/api.php        # API routes (JSON responses)
  
  implementation:
    - Single entry point through public/index.php
    - All requests routed through central router
    - RESTful route patterns with parameter extraction
    - Legacy URLs handled via route definitions
    - No direct file access in production
    - Router converts {param} patterns to regex capture groups
    - Parameters extracted to $_GET array for controller access
    - Controllers instantiated with container and config in executeRoute()
    - No route caching or compilation
    - No route groups or prefixes
    - Direct method calls for route registration
  
  recent_fixes:
    - Confirmed Apache DocumentRoot points to /public/
    - Fixed Shop entity database column mismatch
    - Added defensive NULL handling in controllers
    - Resolved homepage rendering with output buffering
    - Cleared PHP opcache to load fixes

authentication:
  unified_system:
    service: YFEvents\Application\Services\AuthService
    provider: YFEvents\Modules\YFAuth\Services\AuthService
    description: Centralized authentication wrapper
    features:
      - Single login interface for all user types
      - Standardized session management
      - Role-based access control (RBAC)
      - Automatic session regeneration
    session_structure:
      auth:
        - user_id
        - username
        - email
        - roles[]
        - permissions[]
        - session_id
        - login_time
        - last_activity
  
  deprecated:
    - Legacy admin authentication (hardcoded credentials)
    - Direct YFClaim seller authentication
    - Multiple session variable patterns
    - Hardcoded passwords in controllers

database:
  connection: MySQL/MariaDB
  name: yakima_finds
  user_table: yfa_auth_users    # Standardized from 'users' references
  tables:
    core:
      - events
      - event_categories
      - calendar_sources    # Moved before events to resolve FK dependency
      - local_shops        # Note: only has 'status' column, not 'active'
      - shop_categories    # Moved before local_shops to resolve FK dependency
      - shop_owners       # Moved before local_shops to resolve FK dependency
      
    modules:
      - yfa_auth_*        # YFAuth module tables (includes main user table)
      - yfc_*             # YFClaim module tables (yfc_sellers.password_hash now nullable)
      - theme_*           # YFTheme module tables
      
    communication:
      - communication_channels      # Chat channels/rooms
      - communication_messages      # Messages with threading support
      - communication_participants  # Channel membership and permissions
      - communication_attachments   # File attachments for messages
      - communication_reactions     # Message reactions (emoji)
      - communication_notifications # User notifications and alerts
      - communication_email_addresses # Email integration for channels
      
    system:
      - modules
      - module_settings
      - audit_log
      - scraping_logs

testing:
  structure:
    - tests/             # Root directory with custom test scripts
    - tests/Unit/        # Unit tests directory (exists but mostly unused)
    - tests/Feature/     # Feature tests directory (exists but mostly unused)
    - tests/Integration/ # Integration tests directory (exists but mostly unused)
    - tests/Scripts/     # Custom test scripts
  approach:
    - Custom PHP test scripts (not PHPUnit framework)
    - Manual test execution
    - No formal test framework actively used despite PHPUnit in composer.json
  main_scripts:
    - tests/run_all_tests.php
    - tests/test_core_functionality.php
    - tests/test_web_interfaces.php
    - tests/test_yfclaim.php

deployment:
  composer:
    autoload:
      "YFEvents\\": "src/"
      "YFEvents\\Modules\\": "modules/"
    autoload-dev:
      "YFEvents\\Tests\\": "tests/"
      
  commands:
    - composer install
    - composer dump-autoload -o
    - cp .env.example .env
    - # Configure .env with actual values
    - # Run database import: ./scripts/import_database.sh
  
  automated_deployment:
    location: scripts/deploy/
    target_platform: Digital Ocean (Ubuntu 22.04)
    process:
      - wget deployment scripts from GitHub
      - Run setup-server.sh to prepare LAMP stack
      - Run deploy.sh with repository URL
      - Script clones to /var/www/yfevents
      - Configures Apache, SSL, database, and cron
    scripts:
      setup-server.sh: Installs LAMP stack and dependencies
      deploy.sh: Main deployment orchestrator
      create-admin.php: Interactive admin user creation
      health-check.php: Verifies installation health
      run-sql-files.php: Executes database schemas in order
      apache-vhost.conf: Virtual host template

development_environment:
  platform: Ubuntu 22.04 LTS (WSL2)
  stack:
    - PHP 8.1 with required extensions
    - MySQL 8.0
    - Apache 2.4 with mod_rewrite
    - Composer 2.x
  
  configuration:
    - Virtual host configured for localhost
    - Document root: /mnt/d/YFEventsCopy/public
    - Database: yakima_finds (user: yfevents)
    - Environment file: .env with APP_KEY generated
    
  issues_resolved:
    - Router group() method: Simplified routes to not use groups
    - Database foreign key ordering: Reordered table creation
    - User table references: Standardized to yfa_auth_users
    - Composer dependencies: Downgraded from PHP 8.2 to 8.1 compatible
    - Shop entity 'active' property: Removed redundant field
    - ClaimsController NULL dates: Added proper NULL handling
    - Homepage rendering: Fixed heredoc issue with output buffering

recent_changes:
  authentication_unification:
    - Created unified AuthService wrapper
    - Migrated all authentication to YFAuth module
    - Standardized session variables across system
    - Removed hardcoded admin credentials
    - Updated ClaimsController to use AuthService
    
  yfclaim_refactoring:
    - Removed offer/bidding functionality completely
    - Sellers now authenticate via YFAuth (no local passwords)
    - Fixed database column mappings (preview_start/end vs start_date/end_date)
    - Fixed price field naming (price vs starting_price)
    - Added proper POST routes for form submissions
    - Implemented RESTful seller routes with parameter mapping
    - Contact form system to replace bidding (pending implementation)
    
  database_updates:
    - yfc_sellers.password_hash made nullable
    - Column naming standardized to match actual schema
    - No new migrations needed (working with existing schema)
    
  deprecated_features:
    - YFClaim offer/bidding system
    - Direct password handling in modules
    - Multiple authentication patterns
    - Hardcoded credentials
    - Non-RESTful route patterns

refactoring_progress:
  completed:
    - Phase 1: Preparation and Planning
    - Phase 2: Create Clean Directory Structure
    - Phase 3: Migrate to Clean Architecture
    - Phase 4: Move Assets and Admin
    - Phase 5: Module Integration
    - Phase 6: Database Schema Consolidation (documented, not merged)
    - Phase 7: Clean Up (removed old refactor, organized tests)
    - Phase 8: Configuration Updates
      - Updated composer.json namespaces
      - Created comprehensive .env.example
      - Updated config files to use env vars
      - Fixed entry point paths
    - Phase 9: Namespace Updates
      - Updated all PHP files from YakimaFinds to YFEvents namespace
      - Fixed EnvLoader namespace to YFEvents\Infrastructure\Utils
      - Updated use statements and fully qualified class names
      - 383 references updated to 30 (remaining are string literals)
      
  in_progress:
    - Development Environment Setup:
      - LAMP stack installed and configured
      - Database partially imported (19 tables)
      - Application accessible at http://localhost
      - Chat system fully implemented with communication_* tables
      
  pending:
    - Phase 10: Testing & Verification
    - Phase 11: Final Review
    - Phase 12: Post-Refactor Setup

  chat_system_implementation:
    completed:
      - Domain layer with entities and value objects
      - Infrastructure repositories for all chat tables
      - Application services (CommunicationService, AdminSellerChatService)
      - API controllers for channels, messages, notifications
      - Container registration with dependency injection
      - Database schema using communication_* tables
      - Seed script for global Support and Selling Tips channels
    
    architecture_decisions:
      - Used communication_schema_fixed.sql for advanced features
      - Domain types: public, private, event, vendor, announcement
      - Message types: text, system, announcement
      - Repository pattern with simplified field mapping
      - Service layer for business logic orchestration
      - PWA support with service worker for offline capability
    
    integration:
      - Authentication via YFAuth module
      - Session management standardized
      - Role-based access control
      - YFClaim item references in messages
    
    integration_complete:
      - Seller dashboard integration via iframe
      - Real-time unread badge updates
      - Auto-join channels on seller login
      - API endpoint /api/communication/unread-count
      - Full documentation at docs/CHAT_SYSTEM_DOCUMENTATION.md

  homepage_overhaul:
    completed:
      - Phase 1: Container Registration
        - Fixed QRCodeService interface dependency
        - Created missing Claims repositories (Sale, Item, Offer)
        - Removed offer dependencies from ClaimService
        - Registered all repositories in ServiceProvider
      - Phase 2: Dynamic Homepage Content
        - Created PaginatedResult DTO
        - Injected services into HomeController
        - Added dynamic data fetching methods
        - Fixed Sale::fromArray column mappings
        - Homepage displays dynamic stats and content
      - Phase 3: Item Gallery Feature
        - Added /claims/items route for browsing all items
        - Created ItemRepository methods for cross-sale queries
        - Implemented filtering (category, price, search)
        - Added sorting and pagination
        - Responsive grid layout matching existing design
        - API endpoint for AJAX support
      - Phase 4: Routing System Fixes
        - Fixed Shop entity 'active' property issue
        - Added NULL handling for pickup dates in ClaimsController
        - Resolved homepage rendering with HomeControllerFixed trait
        - Migrated from heredoc to output buffering for reliability
    
    features_added:
      - Dynamic homepage with real data
      - Cross-sale item browsing gallery
      - Advanced filtering and search
      - Responsive design improvements
      - Fallback to static content on errors
    
    database_considerations:
      - Handled column name inconsistencies
      - Category as string (not ID) in items table
      - Image filename vs file_path mapping
      - Compatible with existing production schema
      - Shop table only has 'status' column, not 'active'

notes:
  - All hardcoded credentials removed from config files and controllers
  - Environment variables used throughout
  - Module system preserved and enhanced
  - Clean Architecture principles applied
  - Backwards compatibility maintained where possible
  - Security improvements implemented (unified auth, session management)
  - Production database schema preserved (with minor nullable adjustments)
  - YFClassifieds module skipped (overlaps with YFClaim)
  - Router simplified to not require group() method
  - Database schemas reordered to resolve dependencies
  - Authentication fully centralized through AuthService
  - YFClaim simplified to focus on sales without bidding complexity
  - RESTful routing patterns implemented for seller workflows
  - Session variables standardized across all modules